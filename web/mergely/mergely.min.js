"use strict";(function(t,e,i,s){var r={Timer:function(){var t=this;t.start=function(){t.t0=(new Date).getTime()},t.stop=function(){var e=(new Date).getTime(),i=e-t.t0;return t.t0=e,i},t.start()}};r.ChangeExpression=new RegExp(/(^(?![><\-])*\d+(?:,\d+)?)([acd])(\d+(?:,\d+)?)/),r.DiffParser=function(t){for(var e=[],i=0,s=t.split(/\n/),h=0;h<s.length;++h)if(0!=s[h].length){var n={},o=r.ChangeExpression.exec(s[h]);if(null!=o){var l=o[1].split(",");n["lhs-line-from"]=l[0]-1,1==l.length?n["lhs-line-to"]=l[0]-1:n["lhs-line-to"]=l[1]-1;var a=o[3].split(",");n["rhs-line-from"]=a[0]-1,1==a.length?n["rhs-line-to"]=a[0]-1:n["rhs-line-to"]=a[1]-1,n.op=o[2],e[i++]=n}}return e},r.sizeOf=function(t){var e,i=0;for(e in t)t.hasOwnProperty(e)&&i++;return i},r.LCS=function(t,e){this.x=t.replace(/[ ]{1}/g,"\n"),this.y=e.replace(/[ ]{1}/g,"\n")},i.extend(r.LCS.prototype,{clear:function(){this.ready=0},diff:function(t,e){for(var i=new r.diff(this.x,this.y,{ignorews:!1}),s=r.DiffParser(i.normal_form()),h=0,n=0,o=0;o<s.length;++o){var l=s[o];if("a"!=l.op){h=i.getLines("lhs").slice(0,l["lhs-line-from"]).join(" ").length,n=l["lhs-line-to"]+1;var a=i.getLines("lhs").slice(l["lhs-line-from"],n).join(" ");"d"==l.op?a+=" ":h>0&&"c"==l.op&&(h+=1),e(h,h+a.length)}if("d"!=l.op){h=i.getLines("rhs").slice(0,l["rhs-line-from"]).join(" ").length,n=l["rhs-line-to"]+1;var d=i.getLines("rhs").slice(l["rhs-line-from"],n).join(" ");"a"==l.op?d+=" ":h>0&&"c"==l.op&&(h+=1),t(h,h+d.length)}}}}),r.CodeifyText=function(t){this._max_code=0,this._diff_codes={},this.ctxs={},this.options={ignorews:!1},i.extend(this,t),this.lhs=t.lhs.split("\n"),this.rhs=t.rhs.split("\n")},i.extend(r.CodeifyText.prototype,{getCodes:function(t){if(!this.ctxs.hasOwnProperty(t)){var e=this._diff_ctx(this[t]);this.ctxs[t]=e,e.codes.length=Object.keys(e.codes).length}return this.ctxs[t].codes},getLines:function(t){return this.ctxs[t].lines},_diff_ctx:function(t){var e={i:0,codes:{},lines:t};return this._codeify(t,e),e},_codeify:function(t,e){this._max_code;for(var i=0;i<t.length;++i){var s=t[i];this.options.ignorews&&(s=s.replace(/\s+/g,"")),this.options.ignorecase&&(s=s.toLowerCase());var r=this._diff_codes[s];null!=r?e.codes[i]=r:(this._max_code++,this._diff_codes[s]=this._max_code,e.codes[i]=this._max_code)}}}),r.diff=function(t,e,s){var h=i.extend({ignorews:!1},s);this.codeify=new r.CodeifyText({lhs:t,rhs:e,options:h});var n={codes:this.codeify.getCodes("lhs"),modified:{}},o={codes:this.codeify.getCodes("rhs"),modified:{}},l=(n.codes.length,o.codes.length,[]),a=[];this._lcs(n,0,n.codes.length,o,0,o.codes.length,a,l),this._optimize(n),this._optimize(o),this.items=this._create_diffs(n,o)},i.extend(r.diff.prototype,{changes:function(){return this.items},getLines:function(t){return this.codeify.getLines(t)},normal_form:function(){for(var t="",e=0;e<this.items.length;++e){var i=this.items[e],s="",r="",h="c";0==i.lhs_deleted_count&&i.rhs_inserted_count>0?h="a":i.lhs_deleted_count>0&&0==i.rhs_inserted_count&&(h="d"),s=1==i.lhs_deleted_count?i.lhs_start+1:0==i.lhs_deleted_count?i.lhs_start:i.lhs_start+1+","+(i.lhs_start+i.lhs_deleted_count),r=1==i.rhs_inserted_count?i.rhs_start+1:0==i.rhs_inserted_count?i.rhs_start:i.rhs_start+1+","+(i.rhs_start+i.rhs_inserted_count),t+=s+h+r+"\n";var n=this.getLines("lhs"),o=this.getLines("rhs");if(o&&n){var l;for(l=i.lhs_start;l<i.lhs_start+i.lhs_deleted_count;++l)t+="< "+n[l]+"\n";for(i.rhs_inserted_count&&i.lhs_deleted_count&&(t+="---\n"),l=i.rhs_start;l<i.rhs_start+i.rhs_inserted_count;++l)t+="> "+o[l]+"\n"}}return t},_lcs:function(t,e,i,s,r,h,n,o){for(;e<i&&r<h&&t.codes[e]==s.codes[r];)++e,++r;for(;e<i&&r<h&&t.codes[i-1]==s.codes[h-1];)--i,--h;if(e==i)for(;r<h;)s.modified[r++]=!0;else if(r==h)for(;e<i;)t.modified[e++]=!0;else{var l=this._sms(t,e,i,s,r,h,n,o);this._lcs(t,e,l.x,s,r,l.y,n,o),this._lcs(t,l.x,i,s,l.y,h,n,o)}},_sms:function(t,e,i,s,r,h,n,o){var l=t.codes.length+s.codes.length+1,a=e-r,d=i-h,c=i-e-(h-r),g=0!=(1&c),f=l-a,_=l-d,u=(i-e+h-r)/2+1;o[f+a+1]=e,n[_+d-1]=i;var m,p,v,y,w={x:0,y:0};for(m=0;m<=u;++m){for(p=a-m;p<=a+m;p+=2){for(p==a-m?v=o[f+p+1]:(v=o[f+p-1]+1,p<a+m&&o[f+p+1]>=v&&(v=o[f+p+1])),y=v-p;v<i&&y<h&&t.codes[v]==s.codes[y];)v++,y++;if(o[f+p]=v,g&&d-m<p&&p<d+m&&n[_+p]<=o[f+p])return w.x=o[f+p],w.y=o[f+p]-p,w}for(p=d-m;p<=d+m;p+=2){for(p==d+m?v=n[_+p-1]:(v=n[_+p+1]-1,p>d-m&&n[_+p-1]<v&&(v=n[_+p-1])),y=v-p;v>e&&y>r&&t.codes[v-1]==s.codes[y-1];)v--,y--;if(n[_+p]=v,!g&&a-m<=p&&p<=a+m&&n[_+p]<=o[f+p])return w.x=o[f+p],w.y=o[f+p]-p,w}}throw"the algorithm should never come here."},_optimize:function(t){for(var e=0,i=0;e<t.codes.length;){for(;e<t.codes.length&&(null==t.modified[e]||0==t.modified[e]);)e++;for(i=e;i<t.codes.length&&1==t.modified[i];)i++;i<t.codes.length&&t.codes[e]==t.codes[i]?(t.modified[e]=!1,t.modified[i]=!0):e=i}},_create_diffs:function(t,e){for(var i=[],s=0,r=0,h=0,n=0;h<t.codes.length||n<e.codes.length;)if(h<t.codes.length&&!t.modified[h]&&n<e.codes.length&&!e.modified[n])h++,n++;else{for(s=h,r=n;h<t.codes.length&&(n>=e.codes.length||t.modified[h]);)h++;for(;n<e.codes.length&&(h>=t.codes.length||e.modified[n]);)n++;(s<h||r<n)&&i.push({lhs_start:s,rhs_start:r,lhs_deleted_count:h-s,rhs_inserted_count:n-r})}return i}}),r.mergely=function(t,e){t&&this.init(t,e)},i.extend(r.mergely.prototype,{name:"mergely",init:function(t,e){this.diffView=new r.CodeMirrorDiffView(t,e),this.bind(t)},bind:function(t){this.diffView.bind(t)}}),r.CodeMirrorDiffView=function(t,e){s.defineExtension("centerOnCursor",function(){var t=this.cursorCoords(null,"local");this.scrollTo(null,(t.y+t.yBot)/2-this.getScrollerElement().clientHeight/2)}),this.init(t,e)},i.extend(r.CodeMirrorDiffView.prototype,{init:function(t,e){this.settings={autoupdate:!0,autoresize:!0,rhs_margin:"right",wrap_lines:!1,line_numbers:!0,lcs:!0,sidebar:!0,viewport:!1,ignorews:!1,ignorecase:!1,fadein:"fast",editor_width:"650px",editor_height:"400px",resize_timeout:500,change_timeout:150,fgcolor:{a:"#4ba3fa",c:"#a3a3a3",d:"#ff7f7f",ca:"#4b73ff",cc:"#434343",cd:"#ff4f4f"},bgcolor:"#eee",vpcolor:"rgba(0, 0, 200, 0.5)",lhs:function(t){},rhs:function(t){},loaded:function(){},_auto_width:function(t){return t},resize:function(e){var s=e?16:0,r=i(t).parent().width()+s,h=0;"auto"==this.width?r=this._auto_width(r):(r=this.width,this.editor_width=r),"auto"==this.height?h=i(t).parent().height():(h=this.height,this.editor_height=h);var n=r/2-16-8,o=h,l=i(t);l.find(".mergely-column").css({width:n+"px"}),l.find(".mergely-column, .mergely-canvas, .mergely-margin, .mergely-column textarea, .CodeMirror-scroll, .cm-s-default").css({height:o+"px"}),l.find(".mergely-canvas").css({height:o+"px"}),l.find(".mergely-column textarea").css({width:n+"px"}),l.css({width:r,height:h,clear:"both"}),"none"==l.css("display")&&(0!=this.fadein?l.fadeIn(this.fadein):l.show(),this.loaded&&this.loaded()),this.resized&&this.resized()},_debug:"",resized:function(){}};var s={mode:"text/plain",readOnly:!1,lineWrapping:this.settings.wrap_lines,lineNumbers:this.settings.line_numbers,gutters:["merge","CodeMirror-linenumbers"]};this.lhs_cmsettings={},this.rhs_cmsettings={},this.element=i(t),e&&e.cmsettings&&i.extend(this.lhs_cmsettings,s,e.cmsettings,e.lhs_cmsettings),e&&e.cmsettings&&i.extend(this.rhs_cmsettings,s,e.cmsettings,e.rhs_cmsettings),this.element.bind("destroyed",i.proxy(this.teardown,this)),i.data(t,"mergely",this),this._setOptions(e)},unbind:function(){null!=this.changed_timeout&&clearTimeout(this.changed_timeout),this.editor[this.id+"-lhs"].toTextArea(),this.editor[this.id+"-rhs"].toTextArea(),i(t).off(".mergely")},destroy:function(){this.element.unbind("destroyed",this.teardown),this.teardown()},teardown:function(){this.unbind()},lhs:function(t){this.editor[this.id+"-lhs"].setValue(t)},rhs:function(t){this.editor[this.id+"-rhs"].setValue(t)},update:function(){this._changing(this.id+"-lhs",this.id+"-rhs")},unmarkup:function(){this._clear()},scrollToDiff:function(t){this.changes.length&&("next"==t?this._current_diff==this.changes.length-1?this._current_diff=0:this._current_diff=Math.min(++this._current_diff,this.changes.length-1):"prev"==t&&(0==this._current_diff?this._current_diff=this.changes.length-1:this._current_diff=Math.max(--this._current_diff,0)),this._scroll_to_change(this.changes[this._current_diff]),this._changed(this.id+"-lhs",this.id+"-rhs"))},mergeCurrentChange:function(t){this.changes.length&&("lhs"!=t||this.lhs_cmsettings.readOnly?"rhs"!=t||this.rhs_cmsettings.readOnly||this._merge_change(this.changes[this._current_diff],"lhs","rhs"):this._merge_change(this.changes[this._current_diff],"rhs","lhs"))},scrollTo:function(t,e){var i=this.editor[this.id+"-lhs"],s=this.editor[this.id+"-rhs"];"lhs"==t?(i.setCursor(e),i.centerOnCursor()):(s.setCursor(e),s.centerOnCursor())},_setOptions:function(t){if(i.extend(this.settings,t),this.settings.hasOwnProperty("rhs_margin"))if("left"==this.settings.rhs_margin)this.element.find(".mergely-margin:last-child").insertAfter(this.element.find(".mergely-canvas"));else{var e=this.element.find(".mergely-margin").last();e.appendTo(e.parent())}var s,r;this.settings.hasOwnProperty("sidebar")&&(this.settings.sidebar?this.element.find(".mergely-margin").css({display:"block"}):this.element.find(".mergely-margin").css({display:"none"})),this.settings.hasOwnProperty("wrap_lines")&&this.editor&&(s=this.editor[this.id+"-lhs"],r=this.editor[this.id+"-rhs"],s.setOption("lineWrapping",this.settings.wrap_lines),r.setOption("lineWrapping",this.settings.wrap_lines)),this.settings.hasOwnProperty("line_numbers")&&this.editor&&(s=this.editor[this.id+"-lhs"],r=this.editor[this.id+"-rhs"],s.setOption("lineNumbers",this.settings.line_numbers),r.setOption("lineNumbers",this.settings.line_numbers))},options:function(t){if(!t)return this.settings;this._setOptions(t),this.settings.autoresize&&this.resize(),this.settings.autoupdate&&this.update()},swap:function(){if(!this.lhs_cmsettings.readOnly&&!this.rhs_cmsettings.readOnly){var t=this.editor[this.id+"-lhs"],e=this.editor[this.id+"-rhs"],i=e.getValue();e.setValue(t.getValue()),t.setValue(i)}},merge:function(t){var e=this.editor[this.id+"-lhs"],i=this.editor[this.id+"-rhs"];"lhs"!=t||this.lhs_cmsettings.readOnly?this.rhs_cmsettings.readOnly||i.setValue(e.getValue()):e.setValue(i.getValue())},get:function(t){var e=this.editor[this.id+"-"+t],i=e.getValue();return null==i?"":i},clear:function(t){if(!("lhs"==t&&this.lhs_cmsettings.readOnly||"rhs"==t&&this.rhs_cmsettings.readOnly)){var e=this.editor[this.id+"-"+t];e.setValue("")}},cm:function(t){return this.editor[this.id+"-"+t]},search:function(t,e,i){var s,r=this.editor[this.id+"-lhs"],h=this.editor[this.id+"-rhs"];s="lhs"==t?r:h,i="prev"==i?"findPrevious":"findNext",0!=s.getSelection().length&&this.prev_query[t]==e||(this.cursor[this.id]=s.getSearchCursor(e,{line:0,ch:0},!1),this.prev_query[t]=e);var n=this.cursor[this.id];n[i]()?s.setSelection(n.from(),n.to()):n=s.getSearchCursor(e,{line:0,ch:0},!1)},resize:function(){this.settings.resize(),this._changing(this.id+"-lhs",this.id+"-rhs"),this._set_top_offset(this.id+"-lhs")},diff:function(){var t=this.editor[this.id+"-lhs"].getValue(),e=this.editor[this.id+"-rhs"].getValue(),i=new r.diff(t,e,this.settings);return i.normal_form()},bind:function(e){function r(t,e,s){var r,h;if(!(s.target&&i(s.target).closest(".merge-button").length>0))for(r=0;r<this.changes.length;r++)if(h=this.changes[r],e>=h[t+"-line-from"]&&e<=h[t+"-line-to"]){this._current_diff=r,setTimeout(function(){this.scrollToDiff()}.bind(this),10);break}}var h,n;if(this.element.hide(),this.id=i(e).attr("id"),this.changed_timeout=null,this.chfns={},this.chfns[this.id+"-lhs"]=[],this.chfns[this.id+"-rhs"]=[],this.prev_query=[],this.cursor=[],this._skipscroll={},this.change_exp=new RegExp(/(\d+(?:,\d+)?)([acd])(\d+(?:,\d+)?)/),null!=i.button)h='<button title="Merge left"></button>',n='<button title="Merge right"></button>';else{var o="opacity:0.4;width:10px;height:15px;background-color:#888;cursor:pointer;text-align:center;color:#eee;border:1px solid: #222;margin-right:5px;margin-top: -2px;";h='<div style="'+o+'" title="Merge left">&lt;</div>',n='<div style="'+o+'" title="Merge right">&gt;</div>'}this.merge_rhs_button=i(n),this.merge_lhs_button=i(h);var l=this.settings.editor_height,a=this.settings.editor_width;this.element.append(i('<div class="mergely-margin" style="height: '+l+'"><canvas id="'+this.id+'-lhs-margin" width="8px" height="'+l+'"></canvas></div>')),this.element.append(i('<div style="position:relative;width:'+a+"; height:"+l+'" id="'+this.id+'-editor-lhs" class="mergely-column"><textarea style="" id="'+this.id+'-lhs"></textarea></div>')),this.element.append(i('<div class="mergely-canvas" style="height: '+l+'"><canvas id="'+this.id+"-lhs-"+this.id+'-rhs-canvas" style="width:28px" width="28px" height="'+l+'"></canvas></div>'));var d=i('<div class="mergely-margin" style="height: '+l+'"><canvas id="'+this.id+'-rhs-margin" width="8px" height="'+l+'"></canvas></div>');this.settings.sidebar||this.element.find(".mergely-margin").css({display:"none"}),"left"==this.settings.rhs_margin&&this.element.append(d),this.element.append(i('<div style="width:'+a+"; height:"+l+'" id="'+this.id+'-editor-rhs" class="mergely-column"><textarea style="" id="'+this.id+'-rhs"></textarea></div>')),"left"!=this.settings.rhs_margin&&this.element.append(d);var c=i('<div style="display:none" class="mergely current start" />').appendTo("body").css("border-top-color");this.current_diff_color=c;var g="#"+this.id+" .CodeMirror-gutter-text { padding: 5px 0 0 0; }#"+this.id+" .CodeMirror-lines pre, #"+this.id+" .CodeMirror-gutter-text pre { line-height: 18px; }.CodeMirror-linewidget { overflow: hidden; };";this.settings.autoresize&&(g+=this.id+" .CodeMirror-scroll { height: 100%; overflow: auto; }"),g+="\n.CodeMirror { line-height: 18px; }",i('<style type="text/css">'+g+"</style>").appendTo("head");var f=this.element.find("#"+this.id+"-rhs").get(0);if(f){var _=this.element.find("#"+this.id+"-lhs").get(0);if(f){var u,m=this;if(this.editor=[],this.editor[this.id+"-lhs"]=s.fromTextArea(_,this.lhs_cmsettings),this.editor[this.id+"-rhs"]=s.fromTextArea(f,this.rhs_cmsettings),this.editor[this.id+"-lhs"].on("change",function(){m.settings.autoupdate&&m._changing(m.id+"-lhs",m.id+"-rhs")}),this.editor[this.id+"-lhs"].on("scroll",function(){m._scrolling(m.id+"-lhs")}),this.editor[this.id+"-rhs"].on("change",function(){m.settings.autoupdate&&m._changing(m.id+"-lhs",m.id+"-rhs")}),this.editor[this.id+"-rhs"].on("scroll",function(){m._scrolling(m.id+"-rhs")}),this.settings.autoresize){var p=null,v=function(t){m.settings.resize&&m.settings.resize(t),m.editor[m.id+"-lhs"].refresh(),m.editor[m.id+"-rhs"].refresh(),m.settings.autoupdate&&m._changing(m.id+"-lhs",m.id+"-rhs")};i(t).on("resize.mergely",function(){p&&clearTimeout(p),p=setTimeout(v,m.settings.resize_timeout)}),v(!0)}this.editor[this.id+"-lhs"].on("gutterClick",function(t,e,i,s){r.call(this,"lhs",e,s)}.bind(this)),this.editor[this.id+"-rhs"].on("gutterClick",function(t,e,i,s){r.call(this,"rhs",e,s)}.bind(this)),this.settings.lhs&&(u=this.editor[this.id+"-lhs"].getDoc().setValue,this.settings.lhs(u.bind(this.editor[this.id+"-lhs"].getDoc()))),this.settings.rhs&&(u=this.editor[this.id+"-rhs"].getDoc().setValue,this.settings.rhs(u.bind(this.editor[this.id+"-rhs"].getDoc())))}else console.error("lhs textarea not defined - Mergely not initialized properly")}else console.error("rhs textarea not defined - Mergely not initialized properly")},_scroll_to_change:function(t){if(t){var e=this,i=e.editor[e.id+"-lhs"],s=e.editor[e.id+"-rhs"];i.setCursor(Math.max(t["lhs-line-from"],0),0),s.setCursor(Math.max(t["rhs-line-from"],0),0),i.scrollIntoView({line:t["lhs-line-to"]})}},_scrolling:function(t){if(!0!==this._skipscroll[t]){var e=i(this.editor[t].getScrollerElement());null==this.midway&&(this.midway=(e.height()/2+e.offset().top).toFixed(2));var s=this.editor[t].coordsChar({left:0,top:this.midway}),h=e.scrollTop(),n=e.scrollLeft();this.trace("scroll","side",t),this.trace("scroll","midway",this.midway),this.trace("scroll","midline",s),this.trace("scroll","top_to",h),this.trace("scroll","left_to",n);var o=this.id+"-lhs",l=this.id+"-rhs";for(var a in this.editor)if(this.editor.hasOwnProperty(a)&&t!=a){for(var d=t.replace(this.id+"-",""),c=a.replace(this.id+"-",""),g=0,f=null,_=!1,u=0;u<this.changes.length;++u){var m=this.changes[u];s.line>=m[d+"-line-from"]&&(f=m,s.line>=f[d+"-line-to"]&&(m.hasOwnProperty(d+"-y-start")&&m.hasOwnProperty(d+"-y-end")&&m.hasOwnProperty(c+"-y-start")&&m.hasOwnProperty(c+"-y-end")?g+=m[d+"-y-end"]-m[d+"-y-start"]-(m[c+"-y-end"]-m[c+"-y-start"]):_=!0))}var p=this.editor[a].getViewport(),v=!0;if(f&&(this.trace("scroll","last change before midline",f),s.line>=p.from&&s<=p.to&&(v=!1)),this.trace("scroll","scroll",v),v||_?(this.trace("scroll","scrolling other side",h-g),this._skipscroll[a]=!0,this.editor[a].scrollTo(n,h-g)):this.trace("scroll","not scrolling other side"),this.settings.autoupdate){var y=new r.Timer;this._calculate_offsets(o,l,this.changes),this.trace("change","offsets time",y.stop()),this._markup_changes(o,l,this.changes),this.trace("change","markup time",y.stop()),this._draw_diff(o,l,this.changes),this.trace("change","draw time",y.stop())}this.trace("scroll","scrolled")}}else this._skipscroll[t]=!1},_changing:function(t,e){this.trace("change","changing-timeout",this.changed_timeout);var i=this;null!=this.changed_timeout&&clearTimeout(this.changed_timeout),this.changed_timeout=setTimeout(function(){var s=new r.Timer;i._changed(t,e),i.trace("change","total time",s.stop())},this.settings.change_timeout)},_changed:function(t,e){this._clear(),this._diff(t,e)},_clear:function(){var t,e,i,s,h,n,o,l=this,a=function(){for(s=new r.Timer,h=0,o=e.lineCount();h<o;++h)e.removeLineClass(h,"background");for(h=0;h<i.length;++h)n=i[h],n.lines.length&&l.trace("change","clear text",n.lines[0].text),n.clear();e.clearGutter("merge"),l.trace("change","clear time",s.stop())};for(t in this.editor)this.editor.hasOwnProperty(t)&&(e=this.editor[t],i=l.chfns[t],e.operation(a));l.chfns[t]=[];var d=this._draw_info(this.id+"-lhs",this.id+"-rhs"),c=d.clhs.get(0).getContext("2d"),g=d.crhs.get(0).getContext("2d"),f=d.dcanvas.getContext("2d");c.beginPath(),c.fillStyle=this.settings.bgcolor,c.strokeStyle="#888",c.fillRect(0,0,6.5,d.visible_page_height),c.strokeRect(0,0,6.5,d.visible_page_height),g.beginPath(),g.fillStyle=this.settings.bgcolor,g.strokeStyle="#888",g.fillRect(0,0,6.5,d.visible_page_height),g.strokeRect(0,0,6.5,d.visible_page_height),f.beginPath(),f.fillStyle="#fff",f.fillRect(0,0,this.draw_mid_width,d.visible_page_height)},_diff:function(t,e){var i=this.editor[t].getValue(),s=this.editor[e].getValue(),h=new r.Timer,n=new r.diff(i,s,this.settings);this.trace("change","diff time",h.stop()),this.changes=r.DiffParser(n.normal_form()),this.trace("change","parse time",h.stop()),void 0===this._current_diff&&this.changes.length&&(this._current_diff=0,this._scroll_to_change(this.changes[0])),this.trace("change","scroll_to_change time",h.stop()),this._calculate_offsets(t,e,this.changes),this.trace("change","offsets time",h.stop()),this._markup_changes(t,e,this.changes),this.trace("change","markup time",h.stop()),this._draw_diff(t,e,this.changes),this.trace("change","draw time",h.stop())},_parse_diff:function(t,e,i){this.trace("diff","diff results:\n",i);for(var s=[],r=0,h=i.split(/\n/),n=0;n<h.length;++n)if(0!=h[n].length){var o={},l=this.change_exp.exec(h[n]);if(null!=l){var a=l[1].split(",");o["lhs-line-from"]=a[0]-1,1==a.length?o["lhs-line-to"]=a[0]-1:o["lhs-line-to"]=a[1]-1;var d=l[3].split(",");o["rhs-line-from"]=d[0]-1,1==d.length?o["rhs-line-to"]=d[0]-1:o["rhs-line-to"]=d[1]-1,o["lhs-line-from"]<0&&(o["lhs-line-from"]=0),o["lhs-line-to"]<0&&(o["lhs-line-to"]=0),o["rhs-line-from"]<0&&(o["rhs-line-from"]=0),o["rhs-line-to"]<0&&(o["rhs-line-to"]=0),o.op=l[2],s[r++]=o,this.trace("diff","change",o)}}return s},_get_viewport:function(t,e){var i=this.editor[t].getViewport(),s=this.editor[e].getViewport();return{from:Math.min(i.from,s.from),to:Math.max(i.to,s.to)}},_is_change_in_view:function(t,e){return!this.settings.viewport||!(e["lhs-line-from"]<t.from&&e["lhs-line-to"]<t.to||e["lhs-line-from"]>t.from&&e["lhs-line-to"]>t.to||e["rhs-line-from"]<t.from&&e["rhs-line-to"]<t.to||e["rhs-line-from"]>t.from&&e["rhs-line-to"]>t.to)},_set_top_offset:function(t){var e=this.editor[t].getScrollInfo().top;this.editor[t].scrollTo(null,0);var i=this.element.find(".CodeMirror-measure").first(),s=i.offset().top-4;return!!s&&(this.editor[t].scrollTo(null,e),this.draw_top_offset=.5-s,!0)},_calculate_offsets:function(t,e,s){if(null==this.em_height){if(!this._set_top_offset(t))return;this.em_height=this.editor[t].defaultTextHeight(),this.em_height||(console.warn("Failed to calculate offsets, using 18 by default"),this.em_height=18),this.draw_lhs_min=.5;var r=i("#"+t+"-"+e+"-canvas");if(r.length||console.error("failed to find canvas","#"+t+"-"+e+"-canvas"),!r.width())return void console.error("canvas width is 0");this.draw_mid_width=i("#"+t+"-"+e+"-canvas").width(),this.draw_rhs_max=this.draw_mid_width-.5,this.draw_lhs_width=5,this.draw_rhs_width=5,this.trace("calc","change offsets calculated",{top_offset:this.draw_top_offset,lhs_min:this.draw_lhs_min,rhs_max:this.draw_rhs_max,lhs_width:this.draw_lhs_width,rhs_width:this.draw_rhs_width})}for(var h=this.editor[t].charCoords({line:0}),n=this.editor[e].charCoords({line:0}),o=this._get_viewport(t,e),l=0;l<s.length;++l){var a=s[l];if(this.settings.sidebar||this._is_change_in_view(o,a)){var d,c,g,f,_,u,m,p,v,y,w=a["lhs-line-from"]>=0?a["lhs-line-from"]:0,b=a["lhs-line-to"]>=0?a["lhs-line-to"]:0,x=a["rhs-line-from"]>=0?a["rhs-line-from"]:0,C=a["rhs-line-to"]>=0?a["rhs-line-to"]:0;this.editor[t].getOption("lineWrapping")||this.editor[e].getOption("lineWrapping")?(_=this.editor[t].cursorCoords({line:w,ch:0},"page"),p=this.editor[t].getLineHandle(w),d={top:_.top,bottom:_.top+p.height},u=this.editor[t].cursorCoords({line:b,ch:0},"page"),m=this.editor[t].getLineHandle(b),c={top:u.top,bottom:u.top+m.height},_=this.editor[e].cursorCoords({line:x,ch:0},"page"),v=this.editor[e].getLineHandle(x),g={top:_.top,bottom:_.top+v.height},u=this.editor[e].cursorCoords({line:C,ch:0},"page"),y=this.editor[e].getLineHandle(C),f={top:u.top,bottom:u.top+y.height}):(d={top:h.top+w*this.em_height,bottom:h.bottom+w*this.em_height+2},c={top:h.top+b*this.em_height,bottom:h.bottom+b*this.em_height+2},g={top:n.top+x*this.em_height,bottom:n.bottom+x*this.em_height+2},f={top:n.top+C*this.em_height,bottom:n.bottom+C*this.em_height+2}),"a"==a.op?x>0&&(d.top=d.bottom,d.bottom+=this.em_height,c=d):"d"==a.op&&w>0&&(g.top=g.bottom,g.bottom+=this.em_height,f=g),a["lhs-y-start"]=this.draw_top_offset+d.top,"c"==a.op||"d"==a.op?a["lhs-y-end"]=this.draw_top_offset+c.bottom:a["lhs-y-end"]=this.draw_top_offset+c.top,a["rhs-y-start"]=this.draw_top_offset+g.top,"c"==a.op||"a"==a.op?a["rhs-y-end"]=this.draw_top_offset+f.bottom:a["rhs-y-end"]=this.draw_top_offset+f.top,this.trace("calc","change calculated",l,a)}else delete a["lhs-y-start"],delete a["lhs-y-end"],delete a["rhs-y-start"],delete a["rhs-y-end"]}return s},_markup_changes:function(t,e,s){this.element.find(".merge-button").remove();var h=this,n=this.editor[t],o=this.editor[e],l=this._current_diff,a=new r.Timer;n.operation(function(){for(var t=0;t<s.length;++t){var e=s[t],i=e["lhs-line-from"]>=0?e["lhs-line-from"]:0,r=e["lhs-line-to"]>=0?e["lhs-line-to"]:0,a=e["rhs-line-from"]>=0?e["rhs-line-from"]:0,d=(e["rhs-line-to"]>=0&&e["rhs-line-to"],["mergely","lhs",e.op,"cid-"+t]);if(n.addLineClass(i,"background","start"),n.addLineClass(r,"background","end"),l==t&&(i!=r&&n.addLineClass(i,"background","current"),n.addLineClass(r,"background","current")),0==i&&0==r&&0==a)n.addLineClass(i,"background",d.join(" ")),n.addLineClass(i,"background","first");else for(var c=i;c<=r;++c)n.addLineClass(c,"background",d.join(" ")),n.addLineClass(c,"background",d.join(" "));if(!o.getOption("readOnly")){var g=h.merge_rhs_button.clone();g.button&&g.button({icons:{primary:"ui-icon-triangle-1-e"},text:!1}),g.addClass("merge-button"),g.attr("id","merge-rhs-"+t),n.setGutterMarker(i,"merge",g.get(0))}}});var d=this._get_viewport(t,e);this.trace("change","markup lhs-editor time",a.stop()),o.operation(function(){for(var t=0;t<s.length;++t){var e=s[t],i=e["lhs-line-from"]>=0?e["lhs-line-from"]:0,r=(e["lhs-line-to"]>=0&&e["lhs-line-to"],e["rhs-line-from"]>=0?e["rhs-line-from"]:0),a=e["rhs-line-to"]>=0?e["rhs-line-to"]:0;if(h._is_change_in_view(d,e)){var c=["mergely","rhs",e.op,"cid-"+t];if(o.addLineClass(r,"background","start"),o.addLineClass(a,"background","end"),l==t&&(r!=a&&o.addLineClass(r,"background","current"),o.addLineClass(a,"background","current")),0==r&&0==a&&0==i)o.addLineClass(r,"background",c.join(" ")),o.addLineClass(r,"background","first");else for(var g=r;g<=a;++g)o.addLineClass(g,"background",c.join(" ")),o.addLineClass(g,"background",c.join(" "));if(!n.getOption("readOnly")){var f=h.merge_lhs_button.clone();f.button&&f.button({icons:{primary:"ui-icon-triangle-1-w"},text:!1}),f.addClass("merge-button"),f.attr("id","merge-lhs-"+t),o.setGutterMarker(r,"merge",f.get(0))}}}}),this.trace("change","markup rhs-editor time",a.stop());var c,g,f=[];for(O=0;this.settings.lcs&&O<s.length;++O){var _=s[O],u=_["lhs-line-from"]>=0?_["lhs-line-from"]:0,m=_["lhs-line-to"]>=0?_["lhs-line-to"]:0,p=_["rhs-line-from"]>=0?_["rhs-line-from"]:0,v=_["rhs-line-to"]>=0?_["rhs-line-to"]:0;if(this._is_change_in_view(d,_))if("d"==_.op){var y=u,w=m,b=n.lineInfo(w);b&&f.push([n,{line:y,ch:0},{line:w,ch:b.text.length},{className:"mergely ch d lhs"}])}else if("c"==_.op)for(S=u,c=p,g=0;S>=0&&S<=m||c>=0&&c<=v;++S,++c){var x,C;if(c+g>v)x=n.getLine(S),f.push([n,{line:S,ch:0},{line:S,ch:x.length},{className:"mergely ch d lhs"}]);else if(S+g>m)C=o.getLine(c),f.push([o,{line:c,ch:0},{line:c,ch:C.length},{className:"mergely ch a rhs"}]);else{x=n.getLine(S),C=o.getLine(c);var k=new r.LCS(x,C);k.diff(function(t,e){f.push([o,{line:c,ch:t},{line:c,ch:e},{className:"mergely ch a rhs"}])},function(t,e){f.push([n,{line:S,ch:t},{line:S,ch:e},{className:"mergely ch d lhs"}])})}}}this.trace("change","LCS marktext time",a.stop()),n.operation(function(){for(var t=0;t<f.length;++t){var e=f[t];e[0].doc.id==n.getDoc().id&&h.chfns[h.id+"-lhs"].push(e[0].markText(e[1],e[2],e[3]))}}),o.operation(function(){for(var t=0;t<f.length;++t){var e=f[t];e[0].doc.id==o.getDoc().id&&h.chfns[h.id+"-rhs"].push(e[0].markText(e[1],e[2],e[3]))}}),this.trace("change","LCS markup time",a.stop());var T={lhs:n,rhs:o};this.element.find(".merge-button").on("click",function(t){var e="rhs",s="lhs",r=i(this).parents("#"+h.id+"-editor-lhs");r.length&&(e="lhs",s="rhs");var n=T[e].coordsChar({left:t.pageX,top:t.pageY}),o=null,l=T[e].lineInfo(n.line);i.each(l.bgClass.split(" "),function(t,e){if(0==e.indexOf("cid-"))return o=parseInt(e.split("-")[1],10),!1});var a=h.changes[o];return h._merge_change(a,e,s),!1});var L=i("#mergely-lhs ~ .CodeMirror").find(".CodeMirror-linenumber"),M=i("#mergely-rhs ~ .CodeMirror").find(".CodeMirror-linenumber");M.removeClass("mergely current"),L.removeClass("mergely current");for(var O=0;O<s.length;++O){if(l==O&&"d"!==_.op){_=s[O];var S,P=_["rhs-line-from"],V=_["rhs-line-to"]+1;for(S=P;S<V;S++){var z=(S+1).toString();M.filter(function(t,e){return i(e).text()===z}).addClass("mergely current")}}if(l==O&&"a"!==_.op){_=s[O];for(P=_["lhs-line-from"],V=_["lhs-line-to"]+1,S=P;S<V;S++){z=(S+1).toString();L.filter(function(t,e){return i(e).text()===z}).addClass("mergely current")}}}this.trace("change","markup buttons time",a.stop())},_merge_change:function(t,e,i){if(t){var r,h,n,o=this.editor[this.id+"-lhs"],l=this.editor[this.id+"-rhs"],a={lhs:o,rhs:l},d=a[e].getRange(s.Pos(t[e+"-line-from"],0),s.Pos(t[e+"-line-to"]+1,0));if("c"==t.op)a[i].replaceRange(d,s.Pos(t[i+"-line-from"],0),s.Pos(t[i+"-line-to"]+1,0));else if("rhs"==e)if("a"==t.op)a[i].replaceRange(d,s.Pos(t[i+"-line-from"]+1,0),s.Pos(t[i+"-line-to"]+1,0));else for(h=parseInt(t[i+"-line-from"],10),n=parseInt(t[i+"-line-to"],10),r=n;r>=h;--r)a[i].setCursor({line:r,ch:-1}),a[i].execCommand("deleteLine");else if("lhs"==e)if("a"==t.op)for(h=parseInt(t[i+"-line-from"],10),n=parseInt(t[i+"-line-to"],10),r=n;r>=h;--r)a[i].setCursor({line:r,ch:-1}),a[i].execCommand("deleteLine");else a[i].replaceRange(d,s.Pos(t[i+"-line-from"]+1,0));a.lhs.setValue(a.lhs.getValue()),a.rhs.setValue(a.rhs.getValue()),this._scroll_to_change(t)}},_draw_info:function(t,s){var r=i(this.editor[t].getScrollerElement()).height(),h=i(this.editor[t].getScrollerElement()).children(":first-child").height(),n=e.getElementById(t+"-"+s+"-canvas");if(null==n)throw"Failed to find: "+t+"-"+s+"-canvas";var o=this.element.find("#"+this.id+"-lhs-margin"),l=this.element.find("#"+this.id+"-rhs-margin");return{visible_page_height:r,gutter_height:h,visible_page_ratio:r/h,margin_ratio:r/h,lhs_scroller:i(this.editor[t].getScrollerElement()),rhs_scroller:i(this.editor[s].getScrollerElement()),lhs_lines:this.editor[t].lineCount(),rhs_lines:this.editor[s].lineCount(),dcanvas:n,clhs:o,crhs:l,lhs_xyoffset:i(o).offset(),rhs_xyoffset:i(l).offset()}},_draw_diff:function(t,e,s){var r=this._draw_info(t,e),h=r.clhs.get(0),n=r.crhs.get(0),o=r.dcanvas.getContext("2d"),l=h.getContext("2d"),a=n.getContext("2d");this.trace("draw","visible_page_height",r.visible_page_height),this.trace("draw","gutter_height",r.gutter_height),this.trace("draw","visible_page_ratio",r.visible_page_ratio),this.trace("draw","lhs-scroller-top",r.lhs_scroller.scrollTop()),this.trace("draw","rhs-scroller-top",r.rhs_scroller.scrollTop()),i.each(this.element.find("canvas"),function(){i(this).get(0).height=r.visible_page_height}),r.clhs.unbind("click"),r.crhs.unbind("click"),l.beginPath(),l.fillStyle=this.settings.bgcolor,l.strokeStyle="#888",l.fillRect(0,0,6.5,r.visible_page_height),l.strokeRect(0,0,6.5,r.visible_page_height),a.beginPath(),a.fillStyle=this.settings.bgcolor,a.strokeStyle="#888",a.fillRect(0,0,6.5,r.visible_page_height),a.strokeRect(0,0,6.5,r.visible_page_height);for(var d=this._get_viewport(t,e),c=0;c<s.length;++c){var g=s[c],f=this.settings.fgcolor[g.op];this._current_diff===c&&(f=this.current_diff_color),this.trace("draw",g);var _=(g["lhs-y-start"]+r.lhs_scroller.scrollTop())*r.visible_page_ratio,u=(g["lhs-y-end"]+r.lhs_scroller.scrollTop())*r.visible_page_ratio+1,m=(g["rhs-y-start"]+r.rhs_scroller.scrollTop())*r.visible_page_ratio,p=(g["rhs-y-end"]+r.rhs_scroller.scrollTop())*r.visible_page_ratio+1;if(this.trace("draw","marker calculated",_,u,m,p),l.beginPath(),l.fillStyle=f,l.strokeStyle="#000",l.lineWidth=.5,l.fillRect(1.5,_,4.5,Math.max(u-_,5)),l.strokeRect(1.5,_,4.5,Math.max(u-_,5)),a.beginPath(),a.fillStyle=f,a.strokeStyle="#000",a.lineWidth=.5,a.fillRect(1.5,m,4.5,Math.max(p-m,5)),a.strokeRect(1.5,m,4.5,Math.max(p-m,5)),this._is_change_in_view(d,g)){_=g["lhs-y-start"],u=g["lhs-y-end"],m=g["rhs-y-start"],p=g["rhs-y-end"];var v=3;o.beginPath(),o.strokeStyle=f,o.lineWidth=this._current_diff==c?1.5:1;var y=this.draw_lhs_width,w=u-_-1,b=this.draw_lhs_min,x=_;o.moveTo(b,x),"Microsoft Internet Explorer"==navigator.appName?(o.lineTo(this.draw_lhs_min+this.draw_lhs_width,_),o.lineTo(this.draw_lhs_min+this.draw_lhs_width,u+1),o.lineTo(this.draw_lhs_min,u+1)):(w<=0?o.lineTo(b+y,x):(o.arcTo(b+y,x,b+y,x+v,v),o.arcTo(b+y,x+w,b+y-v,x+w,v)),o.lineTo(b,x+w)),o.stroke(),y=this.draw_rhs_width,w=p-m-1,b=this.draw_rhs_max,x=m,o.moveTo(b,x),"Microsoft Internet Explorer"==navigator.appName?(o.lineTo(this.draw_rhs_max-this.draw_rhs_width,m),o.lineTo(this.draw_rhs_max-this.draw_rhs_width,p+1),o.lineTo(this.draw_rhs_max,p+1)):(w<=0?o.lineTo(b-y,x):(o.arcTo(b-y,x,b-y,x+v,v),o.arcTo(b-y,x+w,b-v,x+w,v)),o.lineTo(b,x+w)),o.stroke();var C=this.draw_lhs_min+this.draw_lhs_width,k=_+(u+1-_)/2,T=this.draw_rhs_max-this.draw_rhs_width,L=m+(p+1-m)/2;o.moveTo(C,k),k==L?o.lineTo(T,L):o.bezierCurveTo(C+12,k-3,T-12,L-3,T,L),o.stroke()}}
l.fillStyle=this.settings.vpcolor,a.fillStyle=this.settings.vpcolor;var M=r.clhs.height()*r.visible_page_ratio,O=r.lhs_scroller.scrollTop()/r.gutter_height*r.clhs.height(),S=r.crhs.height()*r.visible_page_ratio,P=r.rhs_scroller.scrollTop()/r.gutter_height*r.crhs.height();this.trace("draw","cls.height",r.clhs.height()),this.trace("draw","lhs_scroller.scrollTop()",r.lhs_scroller.scrollTop()),this.trace("draw","gutter_height",r.gutter_height),this.trace("draw","visible_page_ratio",r.visible_page_ratio),this.trace("draw","lhs from",O,"lhs to",M),this.trace("draw","rhs from",P,"rhs to",S),l.fillRect(1.5,O,4.5,M),a.fillRect(1.5,P,4.5,S),r.clhs.click(function(t){var e=t.pageY-r.lhs_xyoffset.top-M/2,i=Math.max(0,e/h.height*r.lhs_scroller.get(0).scrollHeight);r.lhs_scroller.scrollTop(i)}),r.crhs.click(function(t){var e=t.pageY-r.rhs_xyoffset.top-S/2,i=Math.max(0,e/n.height*r.rhs_scroller.get(0).scrollHeight);r.rhs_scroller.scrollTop(i)})},trace:function(t){this.settings._debug.indexOf(t)>=0&&(arguments[0]=t+":",console.log([].slice.apply(arguments)))}}),i.pluginMaker=function(t){i.fn[t.prototype.name]=function(e){var s,r=i.makeArray(arguments),h=r.slice(1);if(this.each(function(){var n=i.data(this,t.prototype.name);if(n){if("string"==typeof e)s=n[e].apply(n,h);else if(n.update)return n.update.apply(n,r)}else new t(this,e)}),null!=s)return s}},i.pluginMaker(r.mergely)})(window,document,jQuery,CodeMirror);