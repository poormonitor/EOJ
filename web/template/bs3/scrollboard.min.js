function getSubmitList(t){var e=new Array;return $.ajax({type:"GET",content:"application/x-www-form-urlencoded",url:"contestrank3.php?cid="+t+"&type=json&list=submit",dataType:"json",data:{},async:!1,success:function(t){for(var a in t){var s=t[a];e.push(new Submit(s.submitID,s.userID,s.alphabetID,s.subTime,s.resultID))}},error:function(){alert("获取Submit数据失败")}}),e}function getTeamList(t){var e=new Array;return $.ajax({type:"GET",content:"application/x-www-form-urlencoded",url:"contestrank3.php?cid="+t+"&type=json&list=team",dataType:"json",async:!1,data:{},success:function(t){for(var a in t){var s=t[a];e[s.userID]=new Team(s.userID,s.nickName,s.realName,s.official)}},error:function(){alert("获取Team数据失败")}}),e}function StringToDate(t){var e=new Date;return e.setYear(parseInt(t.substring(0,4),10)),e.setMonth(parseInt(t.substring(5,7)-1,10)),e.setDate(parseInt(t.substring(8,10),10)),e.setHours(parseInt(t.substring(11,13),10)),e.setMinutes(parseInt(t.substring(14,16),10)),e.setSeconds(parseInt(t.substring(17,19),10)),e}function Submit(t,e,a,s,i){this.submitId=t,this.teamId=e,this.alphabetId=a,this.subTime=StringToDate(s),this.resultId=i}function TeamProblem(){this.alphabetId="",this.isAccepted=!1,this.penalty=0,this.acceptedTime=new Date,this.submitCount=0,this.isUnkonwn=!1}function Team(t,e,a,s){this.teamId=t,this.teamName=e,this.teamMember=a,this.official=!0,this.solved=0,this.penalty=0,this.gender=!1,this.submitProblemList=[],this.unkonwnAlphabetIdMap=new Array,this.submitList=[],this.lastRank=0,this.nowRank=0}function TeamCompare(t,e){return t.solved!=e.solved?t.solved>e.solved?-1:1:t.penalty!=e.penalty?t.penalty<e.penalty?-1:1:t.teamId.localeCompare(e.teamId)}function Board(t,e,a,s,i){this.problemCount=t,this.medalCounts=e,this.medalRanks=[],this.medalStr=["gold","silver","bronze"],this.problemList=[],this.startTime=a,this.freezeBoardTime=s,this.teamList=[],this.submitList=[],this.teamNowSequence=[],this.teamNextSequence=[],this.teamCount=0,this.displayTeamPos=0,this.noAnimate=!0;for(var n=65,m=0;m<t;m++)this.problemList.push(String.fromCharCode(n+m));this.medalRanks[0]=e[0];for(m=1;m<this.medalCounts.length;++m)this.medalRanks[m]=this.medalCounts[m]+this.medalRanks[m-1];for(var o in this.submitList=getSubmitList(i),this.teamList=getTeamList(i),this.submitList){var r=this.submitList[o];this.teamList[r.teamId].submitList.push(r)}for(var o in this.teamList){var l=this.teamList[o];l.init(this.startTime,this.freezeBoardTime),this.teamNowSequence.push(l),this.teamCount++}this.displayTeamPos=this.teamCount-1,this.teamNowSequence.sort(function(t,e){return TeamCompare(t,e)}),this.teamNextSequence=this.teamNowSequence.slice(0)}Team.prototype.init=function(t,e){for(var a in this.submitList.sort(function(t,e){return t.submitId-e.submitId}),this.submitList){var s=this.submitList[a],i=this.submitProblemList[s.alphabetId];i||(i=new TeamProblem),i.alphabetId=s.alphabetId,i.isAccepted||(s.subTime>e&&(i.isUnkonwn=!0,this.unkonwnAlphabetIdMap[i.alphabetId]=!0),i.submitCount++,i.isAccepted=0==s.resultId,i.isAccepted&&(i.acceptedTime=s.subTime.getTime()-t.getTime(),i.acceptedTime<e-t&&(i.penalty+=i.acceptedTime+20*(i.submitCount-1)*60*1e3,this.solved++,this.penalty+=i.penalty)),this.submitProblemList[i.alphabetId]=i)}},Team.prototype.countUnkonwnProblme=function(){var t=0;for(var e in this.unkonwnAlphabetIdMap)t++;return t},Team.prototype.updateOneProblem=function(){for(var t in this.submitProblemList){var e=this.submitProblemList[t];if(e.isUnkonwn)return e.isUnkonwn=!1,delete this.unkonwnAlphabetIdMap[e.alphabetId],!!e.isAccepted&&(e.penalty+=e.acceptedTime+20*(e.submitCount-1)*60*1e3,this.solved++,this.penalty+=e.penalty,!0)}},Board.prototype.updateTeamSequence=function(){var t=this.teamNextSequence.slice(0);t.sort(function(t,e){return TeamCompare(t,e)});for(var e=-1,a=0;a<this.teamCount;a++)if(this.teamNextSequence[a].teamId!=t[a].teamId){e=a;break}return this.teamNowSequence=this.teamNextSequence.slice(0),this.teamNextSequence=t.slice(0),e},Board.prototype.UpdateOneTeam=function(){for(var t=this.teamCount-1;t>=0&&this.teamNextSequence[t].countUnkonwnProblme()<1;)t--;if(t>=0)for(;this.teamNextSequence[t].countUnkonwnProblme()>0;){this.teamNextSequence[t].updateOneProblem();return this.teamNextSequence[t]}return null},Board.prototype.showInitBoard=function(){var t=5,e=25,a=4,s=7,i=(100-t-e-a-s)/this.problemCount,n='<div id="timer"></div>        <div class="ranktable-head">            <table class="table">                <tr>                    <th width="'+t+'%">Rank</th>                    <th width="'+e+'%">Team</th>                    <th width="'+a+'%">Solved</th>                    <th width="'+s+'%">Penalty</th>',m="</tr>            </table>        </div>";$("body").append(n+m);for(var o=0;o<this.problemList.length;o++){var r=this.problemList[o],l='<th width="'+i+'%">'+r+"</th>";$(".ranktable-head tr").append(l)}var d=0;for(o=0;o<this.teamCount;o++){var h=this.teamNowSequence[o],u=0,p=-1;if(0!=h.solved){u=o+1,d=u+1;for(var c=this.medalRanks.length-1;c>=0;c--)u<=this.medalRanks[c]&&(p=c)}else u=d,p=-1;n='<div id="team_'+h.teamId+'" class="team-item" team-id="'+h.teamId+'">                     <table class="table">                         <tr>';var b='<th class="rank" width="'+t+'%">'+u+"</th>",v='<td class="team-name" width="'+e+'%"><span>'+h.teamName+"</span></td>",f='<td class="solved" width="'+a+'%">'+h.solved+"</td>",w='<td class="penalty" width="'+s+'%">'+parseInt(h.penalty/1e3/60)+"</td>",I="";for(var T in this.problemList){I+='<td class="problem-status" width="'+i+'%" alphabet-id="'+this.problemList[T]+'">';var y=h.submitProblemList[this.problemList[T]];y&&(y.isUnkonwn?I+='<span class="label label-warning">'+y.submitCount+"</span></td>":y.isAccepted?I+='<span class="label label-success">'+y.submitCount+"/"+parseInt(y.acceptedTime/1e3/60)+"</span></td>":I+='<span class="label label-danger">'+y.submitCount+"</span></td>")}m="</tr>                         </table>                     </div>";var L=n+b+v+f+w+I+m;$("body").append(L),-1!=p&&$("#team_"+h.teamId).addClass(this.medalStr[p])}n='<div id="team-void" class="team-item">                     <table class="table">                         <tr>',b='<th class="rank" width="'+t+'%"></th>',v='<td class="team-name" width="'+e+'%"></td>',f='<td class="solved" width="'+a+'%"></td>',w='<td class="penalty" width="'+s+'%"></td>',I="";for(var T in this.problemList)I+='<td class="problem-status" width="'+i+'%" alphabet-id="'+this.problemList[T]+'"></td>';m="</tr>                         </table>                     </div>",L=n+b+v+f+w+I+m;$("body").append(L);var S=44,C=68;for(o=0;o<this.teamCount;++o){var k=this.teamNowSequence[o].teamId;$('div[team-id="'+k+'"]').stop().animate({top:o*C+S},800)}$("#team-void").stop().animate({top:this.teamCount*C+S},800)},Board.prototype.updateTeamStatus=function(t){var e=this;for(var a in t.submitProblemList){var s=t.submitProblemList[a];problemHTML="",s.isUnkonwn?problemHTML='<span class="label label-warning">'+s.submitCount+"</td>":s.isAccepted?problemHTML='<span class="label label-success">'+s.submitCount+"/"+parseInt(s.acceptedTime/1e3/60)+"</td>":problemHTML='<span class="label label-danger">'+s.submitCount+"</td>";var i=$("#team_"+t.teamId+' .problem-status[alphabet-id="'+a+'"]'),n=i.children('span[class="label label-warning"]');if(0==s.isUnkonwn){$(".team-item.hold").removeClass("hold");var m=$('div[team-id="'+t.teamId+'"]');m.addClass("hold");var o=document.documentElement.clientHeight||document.body.clientHeight||0,r=m.offset().top-o+100;$("body,html").stop().animate({scrollTop:r},500),function(t,e,a){var s=100;n.fadeOut(s).fadeIn(s,function(){$(this).parent().html(a)})}(0,0,problemHTML)}}(function(t,e){$("#timer").animate({margin:0},200,function(){var a=0;for(var s in t.medalStr)$(".team-item").removeClass(t.medalStr[s]);for(s=0;s<t.teamCount;s++){var i=t.teamNextSequence[s],n=-1,o=0;if(0!=i.solved){o=s+1,a=o+1;for(var r=t.medalRanks.length-1;r>=0;r--)o<=t.medalRanks[r]&&(n=r)}else o=a,n=-1;m=$('div[team-id="'+i.teamId+'"]'),-1!=n&&m.addClass(t.medalStr[n]),$("#team_"+i.teamId+" .rank").html(o)}$("#team_"+e.teamId+" .solved").html(e.solved),$("#team_"+e.teamId+" .penalty").html(parseInt(e.penalty/1e3/60))},!1)})(e,t)},Board.prototype.moveTeam=function(t){var e=this;(function(e){for(var a=44,s=68,i=0;i<e.teamCount;++i){var n=e.teamNextSequence[i].teamId;-1!=t?$('div[team-id="'+n+'"]').animate({margin:0},200).animate({top:i*s+a},1e3,function(){e.noAnimate=!0}):$('div[team-id="'+n+'"]').animate({margin:0},200,function(){e.noAnimate=!0})}})(e)},Board.prototype.keydown=function(){if(this.noAnimate){this.noAnimate=!1;var t=this.UpdateOneTeam();if(t){var e=this.updateTeamSequence();this.updateTeamStatus(t),this.moveTeam(e)}else $(".team-item.hold").removeClass("hold")}};